<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ù…Ø³Ù†Ø¬Ø± Ø¬Ù‡Ø§Ù†ÛŒ (Ø³Ø¨Ú© ØªÙ„Ú¯Ø±Ø§Ù…) + ØªÙ…Ø§Ø³ ØµÙˆØªÛŒ/ØªØµÙˆÛŒØ±ÛŒ</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
  <style>
    /* Ø±ÛŒØ´Ù‡ Ø±Ù†Ú¯â€ŒÙ‡Ø§ */
    :root {
      --bg-chat: #ece5dd;
      --bubble-self: #dcf8c6;
      --bubble-other: #ffffff;
      --header: #075e54;
      --accent: #128c7e;
      --text-muted: #666;
      --blue: #34b7f1;
    }
    body {
      font-family: Tahoma, sans-serif;
      margin: 0; padding: 0;
      background-color: var(--bg-chat);
      display: flex; justify-content: center; align-items: center;
      min-height: 100vh;
    }
    .app {
      width: 100%;
      max-width: 950px;
      height: 98vh;
      background: #f7f7f7;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.12);
      display: grid;
      grid-template-rows: auto 1fr auto auto;
      overflow: hidden;
    }
    .header {
      background-color: var(--header);
      color: #fff;
      padding: 12px 16px;
      display: flex; align-items: center; justify-content: space-between;
    }
    .title {
      font-weight: bold;
    }
    .presence {
      font-size: 0.9em;
      color: #cce;
    }
    .activity {
      font-size: 0.85em;
      color: #eef;
      margin-right: 10px;
    }
    .chat {
      background-color: var(--bg-chat);
      overflow-y: auto;
      padding: 8px 14px;
    }
    .message {
      margin: 8px 0;
      padding: 8px 10px;
      border-radius: 7px;
      max-width: 75%;
      word-wrap: break-word;
      line-height: 1.4;
      box-shadow: 0 1px 0.5px rgba(0,0,0,0.13);
      position: relative;
    }
    .message.self {
      background-color: var(--bubble-self);
      margin-left: auto;
      border-top-left-radius: 7px;
      border-bottom-right-radius: 0;
      margin-right: 5px;
    }
    .message.other {
      background-color: var(--bubble-other);
      margin-right: auto;
      border-top-right-radius: 7px;
      border-bottom-left-radius: 0;
      margin-left: 5px;
    }
    .username {
      font-weight: bold;
      font-size: 0.9em;
      color: var(--blue);
      margin-left: 5px;
    }
    .status {
      text-align: center;
      font-style: italic;
      color: var(--text-muted);
      margin: 10px 0;
    }
    .reply {
      font-size: 0.85em;
      color: #444;
      background: rgba(0,0,0,0.05);
      border-radius: 6px;
      padding: 4px 6px;
      margin-bottom: 6px;
    }
    .time {
      font-size: 0.75em;
      color: #999;
      position: absolute;
      bottom: 4px; left: 8px;
    }
    .toolbar {
      background: #f0f0f0;
      display: flex; gap: 8px;
      align-items: center;
      padding: 8px 10px;
    }
    .toolbar button {
      background: var(--accent); color: #fff; border: none;
      padding: 8px 12px; border-radius: 6px; cursor: pointer;
    }
    .inputbar {
      display: flex; gap: 8px;
      padding: 8px 10px; background: #f0f0f0;
    }
    .inputbar input[type="text"] {
      flex: 1; padding: 10px 12px; border: none; border-radius: 20px;
      font-size: 1em; box-shadow: 0 1px 0 rgba(0,0,0,0.08);
    }
    .inputbar button {
      background: var(--accent); color: #fff; border: none;
      padding: 10px 14px; border-radius: 50%; width: 45px; height: 45px;
      display: flex; align-items: center; justify-content: center; cursor: pointer;
      font-size: 1.1em;
    }

    /* Ù¾Ù†Ù„ Ø§Ø³ØªÛŒÚ©Ø± */
    .stickers {
      display: none;
      background: #fff; border-top: 1px solid #ddd;
      padding: 6px; overflow-x: auto; white-space: nowrap;
    }
    .stickers img {
      height: 64px; width: 64px; object-fit: contain; margin: 4px; cursor: pointer;
    }

    /* ØªÙ…Ø§Ø³ ØµÙˆØªÛŒ/ØªØµÙˆÛŒØ±ÛŒ */
    .callbar {
      background: #fff; border-top: 1px solid #ddd;
      display: grid; grid-template-columns: 1fr 1fr;
      gap: 8px; padding: 8px 10px;
    }
    video {
      width: 100%; max-height: 35vh; background: #000; border-radius: 6px;
    }

    /* ÙˆØ§Ú©Ù†Ø´â€ŒÚ¯Ø±Ø§ */
    @media (max-width: 600px) {
      .app { max-width: 100%; height: 100vh; }
      video { max-height: 28vh; }
      .inputbar button { width: 42px; height: 42px; }
    }
  </style>
</head>
<body>

<div class="app" id="app">
  <div class="header">
    <div class="title">Ú¯ÙØªÚ¯ÙˆÛŒ Ø¬Ù‡Ø§Ù†ÛŒ ğŸŒ</div>
    <div>
      <span class="activity" id="activity">â€”</span>
      <span class="presence" id="presence">Ø¢Ù†Ù„Ø§ÛŒÙ†â€ŒÙ‡Ø§: 0</span>
    </div>
  </div>

  <div class="chat" id="chat"></div>

  <div class="toolbar">
    <button id="btn-stickers">Ø§Ø³ØªÛŒÚ©Ø±</button>
    <input type="file" id="file-input" accept="image/*,audio/*" />
    <button id="btn-record">Ø¶Ø¨Ø· ÙˆÛŒØ³</button>
    <button id="btn-stop-record" disabled>ØªÙˆÙ‚Ù Ø¶Ø¨Ø·</button>
  </div>

  <div class="stickers" id="stickers">
    <!-- Ø§Ø³ØªÛŒÚ©Ø±Ù‡Ø§ÛŒ Ù†Ù…ÙˆÙ†Ù‡ (Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ PNG/GIF Ø®ÙˆØ¯Øª Ø±Ùˆ Ø¨Ø°Ø§Ø±ÛŒ) -->
    <img src="https://media.tenor.com/6xj3E3hZVUsAAAAi/party-parrot.gif" alt="sticker" />
    <img src="https://media.tenor.com/2roX3uxz_68AAAAC/cat-cute.gif" alt="sticker" />
    <img src="https://media.tenor.com/1qX4tWJvS9MAAAAC/pepe-happy.gif" alt="sticker" />
  </div>

  <form class="inputbar" id="msg-form">
    <input type="text" id="msg-input" placeholder="ÛŒÚ© Ù¾ÛŒØ§Ù… Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..." autocomplete="off" />
    <button type="submit" title="Ø§Ø±Ø³Ø§Ù„">&#x27A2;</button>
  </form>

  <div class="callbar">
    <div>
      <video id="localVideo" autoplay playsinline muted></video>
    </div>
    <div>
      <video id="remoteVideo" autoplay playsinline></video>
    </div>
    <div style="grid-column: span 2; display: flex; gap: 8px;">
      <button id="btn-voice-call">ØªÙ…Ø§Ø³ ØµÙˆØªÛŒ</button>
      <button id="btn-video-call">ØªÙ…Ø§Ø³ ØªØµÙˆÛŒØ±ÛŒ</button>
      <button id="btn-end-call">Ù¾Ø§ÛŒØ§Ù† ØªÙ…Ø§Ø³</button>
    </div>
  </div>
</div>

<script>
  // ---------------------------
  // Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø± (Ø§Ø² Ø³Ø´Ù† Ø³Ø±ÙˆØ±)
  // ---------------------------
  // Ú†ÙˆÙ† Ø§ÛŒÙ† ØµÙØ­Ù‡ Ø¨Ø¹Ø¯ Ø§Ø² Ù„Ø§Ú¯ÛŒÙ† Ù†Ø´Ø§Ù† Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ØŒ Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø±Ø§ Ø§Ø² Ú©ÙˆÚ©ÛŒ/Ø³Ø´Ù† Ù†ÛŒØ§Ø² Ù†Ø¯Ø§Ø±ÛŒÙ….
  // Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø¯Ú¯ÛŒ Ø§Ø² prompt Ù…ÛŒâ€ŒÚ¯ÛŒØ±ÛŒÙ… Ø§Ú¯Ø± Ù„Ø§Ø²Ù… Ø´Ø¯Ø› Ø§Ù…Ø§ Ø§ÛŒÙ†Ø¬Ø§ ÙØ±Ø¶ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø±Ø§ Ø§Ø² Ø³Ø±ÙˆØ± Ø¨Ø§ Ù…ØªØºÛŒØ± Ø¬Ø§ÛŒâ€ŒÚ¯Ø°Ø§Ø±ÛŒ Ø´ÙˆØ¯.
  // Ø§Ú¯Ø± Ø®ÙˆØ§Ø³ØªÛŒØŒ Ù…ÛŒâ€ŒØ´Ù†Ù‡ Ø¨Ù‡ ØµÙˆØ±Øª server-side ØªØ²Ø±ÛŒÙ‚ Ú©Ù†ÛŒ.

  // Ø¨Ø±Ø§ÛŒ Ø¯Ù…Ùˆ: Ø§Ú¯Ø± Ø³Ø±ÙˆØ± Ø³Ø´Ù† Ø¯Ø§Ø±Ø¯ Ùˆ Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø±Ø§ Ø¯Ø± Ù‚Ø§Ù„Ø¨ Ù†ÛŒØ§ÙˆØ±Ø¯ØŒ Ø§Ø² ÛŒÚ© prompt Ø³Ø§Ø¯Ù‡ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†:
  let username = '{{ session.get("username", "") }}';
  if (!username || username.includes('{')) {
    username = prompt('Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø³Ø´Ù† Ù†Ø§Ø´Ù†Ø§Ø³ Ø§Ø³Øª. Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:', 'Ú©Ø§Ø±Ø¨Ø±');
  }
  const room_id = 'global_chat_room';

  const chatEl = document.getElementById('chat');
  const presenceEl = document.getElementById('presence');
  const activityEl = document.getElementById('activity');
  const msgForm = document.getElementById('msg-form');
  const msgInput = document.getElementById('msg-input');
  const fileInput = document.getElementById('file-input');
  const btnStickers = document.getElementById('btn-stickers');
  const stickersEl = document.getElementById('stickers');
  const btnRecord = document.getElementById('btn-record');
  const btnStopRecord = document.getElementById('btn-stop-record');

  // WebRTC Ø¹Ù†Ø§ØµØ±
  const localVideo = document.getElementById('localVideo');
  const remoteVideo = document.getElementById('remoteVideo');
  const btnVoice = document.getElementById('btn-voice-call');
  const btnVideo = document.getElementById('btn-video-call');
  const btnEnd = document.getElementById('btn-end-call');

  // Socket.IO
  const socket = io();

  // ---------------------------
  // Ù¾ÛŒÙˆØ³ØªÙ† Ø¨Ù‡ Ø§ØªØ§Ù‚
  // ---------------------------
  socket.on('connect', () => {
    socket.emit('join', { username, room: room_id });
  });

  socket.on('status', (data) => {
    const s = document.createElement('div');
    s.className = 'status';
    s.textContent = data.msg;
    chatEl.appendChild(s);
    chatEl.scrollTop = chatEl.scrollHeight;
  });

  socket.on('user_list', (data) => {
    presenceEl.textContent = 'Ø¢Ù†Ù„Ø§ÛŒÙ†â€ŒÙ‡Ø§: ' + (data.users ? data.users.length : 0);
  });

  socket.on('presence', (data) => {
    // Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ ÙˆØ¶Ø¹ÛŒØª Ù‡Ø± Ú©Ø§Ø±Ø¨Ø± Ø±Ø§ Ø¯Ø± Ø³Ø§ÛŒØ¯Ø¨Ø§Ø± Ù†Ø´Ø§Ù† Ø¨Ø¯Ù‡ÛŒØ› Ø§ÛŒÙ†Ø¬Ø§ ÙÙ‚Ø· Ø´Ù…Ø§Ø±Ø´ Ø¯Ø§Ø±ÛŒÙ…
  });

  socket.on('activity', (data) => {
    // state: typing | uploading | recording | idle
    const map = {
      typing: `${data.username} Ø¯Ø± Ø­Ø§Ù„ ØªØ§ÛŒÙ¾...`,
      uploading: `${data.username} Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„ ÙØ§ÛŒÙ„...`,
      recording: `${data.username} Ø¯Ø± Ø­Ø§Ù„ Ø¶Ø¨Ø· ÙˆÛŒØ³...`,
      idle: 'â€”'
    };
    activityEl.textContent = map[data.state] || 'â€”';
  });

  socket.on('new_message', (data) => {
    addMessage(data);
  });

  // ---------------------------
  // Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù…
  // ---------------------------
  function addMessage(data) {
    const div = document.createElement('div');
    div.className = 'message ' + (data.username === username ? 'self' : 'other');

    if (data.username !== username && data.type === 'text') {
      const u = document.createElement('span');
      u.className = 'username';
      u.textContent = data.username;
      div.appendChild(u);
      div.appendChild(document.createTextNode(' Ú¯ÙØª: '));
    }

    if (data.reply_to) {
      const r = document.createElement('div');
      r.className = 'reply';
      r.textContent = 'Ù¾Ø§Ø³Ø® Ø¨Ù‡: ' + data.reply_to;
      div.appendChild(r);
    }

    if (data.type === 'text') {
      div.appendChild(document.createTextNode(data.msg));
    } else if (data.type === 'image') {
      const img = document.createElement('img');
      img.src = data.msg;
      img.style.maxWidth = '100%';
      img.style.borderRadius = '6px';
      div.appendChild(img);
    } else if (data.type === 'audio') {
      const audio = document.createElement('audio');
      audio.controls = true;
      audio.src = data.msg;
      div.appendChild(audio);
    }

    const t = document.createElement('span');
    t.className = 'time';
    try {
      const d = new Date(data.time);
      t.textContent = d.toLocaleTimeString();
    } catch {
      t.textContent = '';
    }
    div.appendChild(t);

    // Ù‚Ø§Ø¨Ù„ÛŒØª Ø±ÛŒÙ¾Ù„Ø§ÛŒ Ø¨Ø§ Ú©Ù„ÛŒÚ© Ø±Ø§Ø³Øª ÛŒØ§ Ø¯Ùˆ Ø¨Ø§Ø± Ú©Ù„ÛŒÚ©
    div.addEventListener('dblclick', () => {
      msgInput.value = '';
      msgInput.placeholder = 'Ù¾Ø§Ø³Ø® Ø¨Ù‡: ' + (data.type === 'text' ? data.msg : `[${data.type}]`);
      msgInput.dataset.replyTo = (data.type === 'text' ? data.msg : `[${data.type}]`);
      msgInput.focus();
    });

    chatEl.appendChild(div);
    chatEl.scrollTop = chatEl.scrollHeight;
  }

  // ---------------------------
  // ØªØ§ÛŒÙ¾ Ú©Ø±Ø¯Ù†
  // ---------------------------
  let typingTimer;
  msgInput.addEventListener('input', () => {
    socket.emit('typing', { username, room: room_id, state: 'typing' });
    clearTimeout(typingTimer);
    typingTimer = setTimeout(() => {
      socket.emit('typing', { username, room: room_id, state: 'idle' });
    }, 1200);
  });

  // ---------------------------
  // Ø§Ø±Ø³Ø§Ù„ Ù…ØªÙ†
  // ---------------------------
  msgForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const msg = msgInput.value.trim();
    if (!msg) return;
    const reply_to = msgInput.dataset.replyTo || null;
    socket.emit('send_message', { username, room: room_id, msg, reply_to });
    msgInput.value = '';
    msgInput.placeholder = 'ÛŒÚ© Ù¾ÛŒØ§Ù… Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯...';
    delete msgInput.dataset.replyTo;
    socket.emit('typing', { username, room: room_id, state: 'idle' });
  });

  // ---------------------------
  // Ø§Ø³ØªÛŒÚ©Ø±
  // ---------------------------
  btnStickers.addEventListener('click', () => {
    stickersEl.style.display = (stickersEl.style.display === 'none' ? 'block' : 'none');
  });
  stickersEl.addEventListener('click', (e) => {
    if (e.target.tagName.toLowerCase() === 'img') {
      // Ø§Ø³ØªÛŒÚ©Ø± Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† ØªØµÙˆÛŒØ± Ù¾ÛŒØ§Ù…
      socket.emit('send_media', { username, room: room_id, url: e.target.src, type: 'image' });
    }
  });

  // ---------------------------
  // Ø¢Ù¾Ù„ÙˆØ¯ ÙØ§ÛŒÙ„ (Ø¹Ú©Ø³/ØµÙˆØª)
  // ---------------------------
  fileInput.addEventListener('change', async (e) => {
    const f = e.target.files[0];
    if (!f) return;
    socket.emit('typing', { username, room: room_id, state: 'uploading' });

    const form = new FormData();
    form.append('file', f);
    try {
      const res = await fetch('/upload', { method: 'POST', body: form });
      const j = await res.json();
      if (j.ok) {
        socket.emit('send_media', { username, room: room_id, url: j.url, type: j.type });
      } else {
        alert(j.error || 'Ø®Ø·Ø§ Ø¯Ø± Ø¢Ù¾Ù„ÙˆØ¯');
      }
    } catch (err) {
      alert('Ù…Ø´Ú©Ù„ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ± Ø¢Ù¾Ù„ÙˆØ¯');
    } finally {
      socket.emit('typing', { username, room: room_id, state: 'idle' });
      e.target.value = '';
    }
  });

  // ---------------------------
  // Ø¶Ø¨Ø· ÙˆÛŒØ³ Ø¨Ø§ MediaRecorder
  // ---------------------------
  let mediaRecorder;
  let chunks = [];

  btnRecord.addEventListener('click', async () => {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      chunks = [];
      mediaRecorder.ondataavailable = e => {
        if (e.data.size > 0) chunks.push(e.data);
      };
      mediaRecorder.onstop = async () => {
        const blob = new Blob(chunks, { type: 'audio/webm' });
        const file = new File([blob], `voice_${Date.now()}.webm`, { type: 'audio/webm' });
        socket.emit('typing', { username, room: room_id, state: 'uploading' });
        const form = new FormData();
        form.append('file', file);
        const res = await fetch('/upload', { method: 'POST', body: form });
        const j = await res.json();
        if (j.ok) {
          socket.emit('send_media', { username, room: room_id, url: j.url, type: j.type });
        } else {
          alert(j.error || 'Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ ÙˆÛŒØ³');
        }
        socket.emit('typing', { username, room: room_id, state: 'idle' });
      };
      mediaRecorder.start();
      btnRecord.disabled = true;
      btnStopRecord.disabled = false;
      socket.emit('typing', { username, room: room_id, state: 'recording' });
    } catch (err) {
      alert('Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ù…ÛŒÚ©Ø±ÙˆÙÙˆÙ† Ø±Ø¯ Ø´Ø¯ ÛŒØ§ Ø®Ø·Ø§ Ø±Ø® Ø¯Ø§Ø¯.');
    }
  });

  btnStopRecord.addEventListener('click', () => {
    if (mediaRecorder && mediaRecorder.state !== 'inactive') {
      mediaRecorder.stop();
      btnRecord.disabled = false;
      btnStopRecord.disabled = true;
      socket.emit('typing', { username, room: room_id, state: 'idle' });
    }
  });

  // ---------------------------
  // WebRTC ØªÙ…Ø§Ø³ ØµÙˆØªÛŒ/ØªØµÙˆÛŒØ±ÛŒ
  // ---------------------------
  let pc;
  let localStream;

  async function startCall(video = false) {
    try {
      localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video });
      localVideo.srcObject = localStream;

      const config = {
        iceServers: [
          { urls: 'stun:stun.l.google.com:19302' } // STUN Ø¹Ù…ÙˆÙ…ÛŒ
        ]
      };
      pc = new RTCPeerConnection(config);
      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

      pc.ontrack = (e) => {
        remoteVideo.srcObject = e.streams[0];
      };

      pc.onicecandidate = (e) => {
        if (e.candidate) {
          socket.emit('rtc_ice', { candidate: e.candidate, room: room_id, from: username });
        }
      };

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      socket.emit('rtc_offer', { offer, room: room_id, from: username });
    } catch (err) {
      alert('Ø´Ø±ÙˆØ¹ ØªÙ…Ø§Ø³ Ù…Ù…Ú©Ù† Ù†Ø´Ø¯: ' + err.message);
    }
  }

  socket.on('rtc_offer', async (data) => {
    try {
      const config = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
      pc = new RTCPeerConnection(config);

      pc.ontrack = (e) => {
        remoteVideo.srcObject = e.streams[0];
      };
      pc.onicecandidate = (e) => {
        if (e.candidate) {
          socket.emit('rtc_ice', { candidate: e.candidate, room: room_id, from: username });
        }
      };

      // Ø¯Ø±ÛŒØ§ÙØª Ù…Ø¯ÛŒØ§ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ø·Ø±Ù Ù…Ù‚Ø§Ø¨Ù„ (Ø§Ú¯Ø± ÙˆÛŒØ¯ÛŒÙˆ Ø¯Ø§Ø´Øª)
      const needVideo = data.offer.sdp.includes('m=video');
      localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: needVideo });
      localVideo.srcObject = localStream;
      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

      await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      socket.emit('rtc_answer', { answer, room: room_id, from: username });
    } catch (err) {
      alert('Ù¾Ø§Ø³Ø® Ø¨Ù‡ ØªÙ…Ø§Ø³ Ù…Ù…Ú©Ù† Ù†Ø´Ø¯: ' + err.message);
    }
  });

  socket.on('rtc_answer', async (data) => {
    try {
      await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
    } catch (err) {
      console.warn('Ø®Ø·Ø§ Ø¯Ø± setRemoteDescription:', err);
    }
  });

  socket.on('rtc_ice', async (data) => {
    try {
      if (data.candidate) {
        await pc.addIceCandidate(new RTCIceCandidate(data.candidate));
      }
    } catch (err) {
      console.warn('Ø®Ø·Ø§ Ø¯Ø± addIceCandidate:', err);
    }
  });

  function endCall() {
    try {
      if (pc) {
        pc.getSenders().forEach(s => {
          try { s.track.stop(); } catch {}
        });
        pc.close();
      }
      pc = null;
      if (localStream) {
        localStream.getTracks().forEach(t => t.stop());
        localStream = null;
      }
      localVideo.srcObject = null;
      remoteVideo.srcObject = null;
    } catch {}
  }

  btnVoice.addEventListener('click', () => startCall(false));
  btnVideo.addEventListener('click', () => startCall(true));
  btnEnd.addEventListener('click', () => endCall());

  // ---------------------------
  // ØªØ±Ú© ØµÙØ­Ù‡
  // ---------------------------
  window.addEventListener('beforeunload', () => {
    socket.emit('left');
    endCall();
  });
</script>

</body>
</html>
